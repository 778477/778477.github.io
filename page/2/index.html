<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>778477</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="778477">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="778477">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="778477">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">778477</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer">
      <article id="post-2017-01-13-Reveal调试越狱设备" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/13/2017-01-13-Reveal调试越狱设备/">Reveal 调试越狱设备</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/01/13/2017-01-13-Reveal调试越狱设备/" class="article-date">
  <time datetime="2017-01-13T00:00:00.000Z" itemprop="datePublished">2017-01-13</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a><span>></span><a class="article-category-link" href="/categories/iOS/工具/">工具</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="使用Reveal调试越狱设备"><a href="#使用Reveal调试越狱设备" class="headerlink" title="使用Reveal调试越狱设备"></a>使用Reveal调试越狱设备</h2><p>网上有很多实践文章。我自己按照网上的教程实验了一把，在这里记录一下。</p>
<ul>
<li>一台越狱设备(iOS 7.1)</li>
<li>Reveal (1.0.3)</li>
</ul>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><ol>
<li><p>确认越狱设备 安装 <code>OpenSSH</code> 和 <code>Cydia Substrate</code>。若无法安装，可以尝试刷新源，然后重新搜索下载</p>
</li>
<li><p><code>scp /Applications/Reveal.app/Contents/SharedSupport/iOS-Libraries/libReveal.dylib root@your.ip.address.xx:/Library/MobileSubstrate/DynamicLibraries</code></p>
</li>
<li><p><code>scp libReveal.plist root@192.168.XXX.XXX:/Library/MobileSubstrate/DynamicLibraries</code></p>
</li>
<li><p>重启设备，就可以在电脑查看<code>libReveal.plist</code>中的App UI了。</p>
</li>
</ol>
<p><code>libReveal.plist</code>文件格式可以为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    Filter = &#123;</span><br><span class="line">        Bundles = (&quot;com.sina.weibo&quot;);</span><br><span class="line">        Bundles = (&quot;com.burbn.instagram&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bundles里面填写你对应想看的App SoftwareBundleIdentifier。这个Plist文件一开始，我很纠结因为网上的文件格式不同于 Apple的标准Plist XML格式。然而拷贝进越狱设备之后，能起效我也就不在意了。</p>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><ol>
<li>我一开始使用的是Reveal 1.6.3版本，拷贝进越狱设备里的也是对应的dylib。没起作用，换了同事的1.0.3安装包就work了。</li>
<li>连接内网之后，电脑和手机一定要确认在同一个局域网(我猜想 Reveal动态库是在局域网广播UI层级信息的)</li>
</ol>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Reveal/">Reveal</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2017-01-09-ASR&amp;Translator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/09/2017-01-09-ASR&Translator/">ASR&amp;Translator</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/01/09/2017-01-09-ASR&Translator/" class="article-date">
  <time datetime="2017-01-09T00:00:00.000Z" itemprop="datePublished">2017-01-09</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ASR-Automatic-Speech-Recognition"><a href="#ASR-Automatic-Speech-Recognition" class="headerlink" title="ASR(Automatic Speech Recognition)"></a>ASR(Automatic Speech Recognition)</h2><p>语音识别使用 Apple iOS10 SDK中的 speech.framework即可</p>
<p>语音识别(ASR)领域，业界还有一个leading framework： <a href="http://www.nuance.com/index.htm" target="_blank" rel="external">Nuance</a> </p>
<p>他们主要搞语音和图像方面，卖各种商业解决方案。早年间传闻 iPhone4S 那代的Siri 语音识别使用Nuance服务器</p>
<h2 id="Translator"><a href="#Translator" class="headerlink" title="Translator"></a>Translator</h2><p>语音识别之后，我们可以利用文本做一些翻译功能：</p>
<p>这里有些branchmark</p>
<ul>
<li><p><a href="http://lifehacker.com/translation-tool-showdown-google-translate-vs-microso-1787836106" target="_blank" rel="external">Translation Tool Showdown: Google Translate vs. Microsoft Translator</a></p>
</li>
<li><p><a href="https://www.slant.co/topics/5775/versus/~google-translate_vs_microsoft-translator_vs_itranslate" target="_blank" rel="external">google-translate_vs_microsoft-translator_vs_itranslate</a></p>
</li>
<li><p><a href="http://www.empowerlinguatranslation.com/microsoft-translator-vs-google-translate/" target="_blank" rel="external">Microsoft Translator Vs Google Translate</a></p>
</li>
</ul>
<p>不过因为，国内Google被墙了。大多数用户访问不了Google的服务。不用比较，只能选择Microsoft了。。。囧</p>
<p>使用Microsoft Translator服务可以实现 翻译功能<br>支持文本翻译文本，文本翻译成语音</p>
<p>Getting Started</p>
<p>To access the Microsoft Translator Text Translation API you will need to sign up for Microsoft Azure. Follow these steps.</p>
<ol>
<li>Sign up for a Microsoft Azure account at <a href="http://azure.com" target="_blank" rel="external">http://azure.com</a></li>
<li>After you have an account go to <a href="http://portal.azure.com" target="_blank" rel="external">http://portal.azure.com</a></li>
<li>Select the + New option.</li>
<li>Select Intelligence from the list of services.</li>
<li>Select Cognitive Services APIs</li>
<li>Select the API Type option.</li>
<li>Select Text Translation.</li>
<li>In the Pricing Tier section select the pricing tier that fits your needs.</li>
<li>Fill out the rest of the form, and select the Create button.</li>
<li>You are now subscribed to Microsoft Translator.</li>
<li>Go to All Resources and select the Microsoft Translator API you subscribed to.</li>
<li>Go to the Keys option and copy your subscription key to access the service.</li>
</ol>
<p><strong>Translator 文本 API</strong></p>
<table>
<thead>
<tr>
<th>Plan</th>
<th style="text-align:center">Description</th>
<th style="text-align:right">Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>免费</td>
<td style="text-align:center">限每月 2M 文字</td>
<td style="text-align:right">免费</td>
</tr>
<tr>
<td>S1 标准</td>
<td style="text-align:center">基于Azure使用量</td>
<td style="text-align:right">每 1M 文字 $10</td>
</tr>
<tr>
<td>S2 标准</td>
<td style="text-align:center">每月 250M 文字</td>
<td style="text-align:right">每月 $2,055，超额部分每 1M 文字 $8.22</td>
</tr>
<tr>
<td>S3 标准</td>
<td style="text-align:center">每月 1B 文字</td>
<td style="text-align:right">每月 $6K，超额部分每 1M 文字 $6.00</td>
</tr>
<tr>
<td>S4 标准</td>
<td style="text-align:center">每月 10B 文字</td>
<td style="text-align:right">每月 $45K，超额部分每 1M 文字 $4.5</td>
</tr>
</tbody>
</table>
<p><strong>Translator 语音 API</strong></p>
<table>
<thead>
<tr>
<th>Plan</th>
<th style="text-align:center">Description</th>
<th style="text-align:right">Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>免费</td>
<td style="text-align:center">限每月 2小时</td>
<td style="text-align:right">免费</td>
</tr>
<tr>
<td>S1 标准</td>
<td style="text-align:center">基于Azure使用量</td>
<td style="text-align:right">每小时 $12</td>
</tr>
<tr>
<td>S2 标准</td>
<td style="text-align:center">每月 100 小时</td>
<td style="text-align:right">每月 $1K，超出部分每小时 $10</td>
</tr>
<tr>
<td>S2 标准</td>
<td style="text-align:center">每月 1000 小时</td>
<td style="text-align:right">每月 $7K，超额部分每小时 $7</td>
</tr>
<tr>
<td>S4 标准</td>
<td style="text-align:center">每月 10,000 小时</td>
<td style="text-align:right">每月 $35K，超额部分每小时 $3.50</td>
</tr>
</tbody>
</table>
<p>PS：还有<a href="https://www.microsoft.com/cognitive-services/en-us/face-api" target="_blank" rel="external">face api</a></p>
<p>具体的文档地址：<a href="http://docs.microsofttranslator.com/text-translate.html" target="_blank" rel="external">text-translate</a></p>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><p><del>一个封装了Microsoft Speech Translator服务的功能库<a href="https://github.com/bitmapdata/MSTranslateVendor" target="_blank" rel="external">MSTranslateVendor</a></del></p>
<p><del><a href="https://msdn.microsoft.com/en-us/library/hh454950.aspx" target="_blank" rel="external">Obtaining an Access Token</a></del></p>
<p>上面举出的Microsoft的API资料都是过期了的文档。不要花时间在这上面-，-。。。</p>
<p>一句话就是：最新的API 已经不需要去注册<code>Azure DataMarket application</code>了，不用<code>client_id</code>和<code>client_secret</code>。直接使用<code>Subscription Key</code>即可</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ASR/">ASR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Translator/">Translator</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-12-29-个人开发者之游戏篇SpriteKit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/29/2016-12-29-个人开发者之游戏篇SpriteKit/">Jumping into SpriteKit</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/12/29/2016-12-29-个人开发者之游戏篇SpriteKit/" class="article-date">
  <time datetime="2016-12-29T00:00:00.000Z" itemprop="datePublished">2016-12-29</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a><span>></span><a class="article-category-link" href="/categories/iOS/SpriteKit/">SpriteKit</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果你对个人开发者还有一些念想的话，游戏领域可能是个人开发者值得投入精力尝试的。<br>比起应用来说，游戏没有涉及到那么多的资源如服务端，产品经理，交互。 如果是简单的样式可能美工方面自己现学就可以搞定了<br>我这里指的是一些简单的游戏，如单场景的消除类:</p>
<ul>
<li><a href="https://itunes.apple.com/cn/app/xiao-chu-fang-kuai-2016mian/id1111099870?mt=8" target="_blank" rel="external">消除方块</a></li>
<li><a href="https://itunes.apple.com/cn/app/duo-cai-fang-kuai-xiao-chu/id943380262?mt=8" target="_blank" rel="external">多彩方块消除</a></li>
<li><a href="https://itunes.apple.com/cn/app/xing-zhi-xiao-chu!pop-star/id790766978?mt=8" target="_blank" rel="external">星之消除!pop star-免费中文消除小游戏</a></li>
</ul>
<p>大体都是一些较为经典的个人开发者作品。盈利模式可以是：App收费，App接入市场广告，App道具收费</p>
<p>好了，下面进入正题。早些年做游戏的话，如果注重跨平台 你的选择可能就是 Cocos2d-X 了。 但其实Apple自身是有套游戏框架: SpriteKit</p>
<p><a href="https://developer.apple.com/library/content/documentation/GraphicsAnimation/Conceptual/SpriteKit_PG/Introduction/Introduction.html#//apple_ref/doc/uid/TP40013043-CH1-SW1" target="_blank" rel="external">About SpriteKit</a></p>
<p>可以按照 Jumping into SpriteKit 这个章节熟悉一下 SpriteKit 。</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p><strong>这里要注意的是 第一步里面一定要将storyboard里面的ViewController 的view object class 设置为 SKView。</strong></p>
<blockquote>
<p>Open the storyboard for the project. It has a single view controller (SpriteViewController). Select the view controller’s view object and change its class to SKView.</p>
</blockquote>
<p><code>SpriteKit</code>内容都是绘制在<code>SKView</code>里面的，而<code>SKView</code>渲染出来的东西叫做 <em>场景(scene)</em> 是<code>SKScene</code>类型。 场景的交互是响应传递链的。</p>
<h2 id="Using-Actions-to-Animate-Scenes"><a href="#Using-Actions-to-Animate-Scenes" class="headerlink" title="Using Actions to Animate Scenes"></a>Using Actions to Animate Scenes</h2><p>每个<code>SKNode</code>都有<code>name</code>属性作为他的描述，给节点起个名字方便你后面查找和指定节点执行动作。 类似<code>UIKit</code>里面的<code>view.tag</code></p>
<p><code>SKAction</code> 需要重点了解一下。</p>
<h2 id="Transitioning-Between-Scenes"><a href="#Transitioning-Between-Scenes" class="headerlink" title="Transitioning Between Scenes"></a>Transitioning Between Scenes</h2><p>这个是区别于<code>UIKit</code>的，没有页面跳转的概念。这里指的 Scene A切换为Scene B。<br>使用<code>SKTransition</code>可以添加切换动画。查看<code>SKTransition.h</code>，SpriteKit还是自带了蛮多场景切换动画。</p>
<h2 id="Creating-Nodes-That-Interact-with-Each-Other"><a href="#Creating-Nodes-That-Interact-with-Each-Other" class="headerlink" title="Creating Nodes That Interact with Each Other"></a>Creating Nodes That Interact with Each Other</h2><p>这个是最有意思的地方： 可以添加<code>SKNode physicsBody</code>属性，让其有物理特性。<br>这里还提到了 <code>didSimulatePhysics</code>,实际上 SpriteKit中 <code>Scene</code> 是在实时重复绘制的。他的每一帧绘制包括了以下时机回调</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> Override this to perform per-frame game logic. Called exactly once per frame before any actions are evaluated and any physics are simulated.</span><br><span class="line"> </span><br><span class="line"> @param currentTime the current time in the app. This must be monotonically increasing.</span><br><span class="line"> */</span><br><span class="line">- (void)update:(NSTimeInterval)currentTime;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Override this to perform game logic. Called exactly once per frame after any actions have been evaluated but before any physics are simulated. Any additional actions applied is not evaluated until the next update.</span><br><span class="line"> */</span><br><span class="line">- (void)didEvaluateActions;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Override this to perform game logic. Called exactly once per frame after any actions have been evaluated and any physics have been simulated. Any additional actions applied is not evaluated until the next update. Any changes to physics bodies is not simulated until the next update.</span><br><span class="line"> */</span><br><span class="line">- (void)didSimulatePhysics;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Override this to perform game logic. Called exactly once per frame after any enabled constraints have been applied. Any additional actions applied is not evaluated until the next update. Any changes to physics bodies is not simulated until the next update. Any changes to constarints will not be applied until the next update.</span><br><span class="line"> */</span><br><span class="line">- (void)didApplyConstraints NS_AVAILABLE(10_10, 8_0);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Override this to perform game logic. Called after all update logic has been completed. Any additional actions applied are not evaluated until the next update. Any changes to physics bodies are not simulated until the next update. Any changes to constarints will not be applied until the next update.</span><br><span class="line"> </span><br><span class="line"> No futher update logic will be applied to the scene after this call. Any values set on nodes here will be used when the scene is rendered for the current frame.</span><br><span class="line"> */</span><br><span class="line">- (void)didFinishUpdate NS_AVAILABLE(10_10, 8_0);</span><br></pre></td></tr></table></figure>
<p><img src="https://developer.apple.com/library/content/documentation/GraphicsAnimation/Conceptual/SpriteKit_PG/Art/update_loop_2x.png" alt="update_loop"></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>来自 raywenderlich 的学习资料 </p>
<ul>
<li><a href="https://www.raywenderlich.com/category/swift" target="_blank" rel="external">swift</a></li>
<li><p><a href="https://www.raywenderlich.com/category/apple-game-frameworks" target="_blank" rel="external">apple-game-frameworks</a></p>
<p>来自 apple 官方的一些资料文档</p>
</li>
<li><p><a href="https://developer.apple.com/library/content/samplecode/SpriteKit_Physics_Collisions/Introduction/Intro.html#//apple_ref/doc/uid/DTS40013390" target="_blank" rel="external">SpriteKit Physics Collisions</a></p>
</li>
<li><a href="https://developer.apple.com/library/content/samplecode/Sprite_Tour/Introduction/Intro.html#//apple_ref/doc/uid/DTS40013389" target="_blank" rel="external">Sprite Tour</a></li>
<li><a href="https://developer.apple.com/library/content/qa/qa1889/_index.html#//apple_ref/doc/uid/DTS40016267" target="_blank" rel="external">Tab-based SpriteKit Apps and Scene Caching</a></li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpriteKit/">SpriteKit</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-12-29-iOS 动态方案探讨" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/29/2016-12-29-iOS 动态方案探讨/">动态化方案</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/12/29/2016-12-29-iOS 动态方案探讨/" class="article-date">
  <time datetime="2016-12-29T00:00:00.000Z" itemprop="datePublished">2016-12-29</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a><span>></span><a class="article-category-link" href="/categories/iOS/动态化方案/">动态化方案</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="已知的一些动态化方案"><a href="#已知的一些动态化方案" class="headerlink" title="已知的一些动态化方案"></a>已知的一些动态化方案</h2><ul>
<li><a href="https://github.com/spotify/HubFramework" target="_blank" rel="external">HubFramework</a></li>
<li><a href="https://github.com/alibaba/weex" target="_blank" rel="external">weex</a></li>
<li><a href="https://github.com/facebook/react-native" target="_blank" rel="external">react-native</a></li>
<li><a href="http://mp.weixin.qq.com/s/DhGR6J5fx04BPi-kMsMBJg" target="_blank" rel="external">OCS</a></li>
<li><a href="https://github.com/DynamicCocoa/DynamicCocoa/issues" target="_blank" rel="external">DynamicCocoa</a></li>
</ul>
<h2 id="List-解耦方案"><a href="#List-解耦方案" class="headerlink" title="List 解耦方案"></a>List 解耦方案</h2><ul>
<li><a href="https://github.com/Instagram/IGListKit" target="_blank" rel="external">IGListKit</a></li>
</ul>
<p>动态化方案的价值，这里就不讨论了。</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/动态化方案/">动态化方案</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-11-01-iOS Responder Chain" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/01/2016-11-01-iOS Responder Chain/">iOS Responder Chain</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/11/01/2016-11-01-iOS Responder Chain/" class="article-date">
  <time datetime="2016-11-01T00:00:00.000Z" itemprop="datePublished">2016-11-01</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Hit-Testing-Returns-the-View-Where-a-Touch-Occurred"><a href="#Hit-Testing-Returns-the-View-Where-a-Touch-Occurred" class="headerlink" title="Hit-Testing Returns the View Where a Touch Occurred"></a>Hit-Testing Returns the View Where a Touch Occurred</h2><p>iOS 使用 <code>hit-testing</code> 找到具体的视图来响应点击。 <code>Hit-testing</code>实现检查了点击手势是落在了哪个视图区域。如果找到了视图，会递归遍历检查该视图下的所有子视图。最终会找到 位于视图层次最靠前(最靠近屏幕)的视图。iOS将其确定为<code>hit-test view</code>，将由它来消费这次<code>touch</code>事件。</p>
<p><img src="https://developer.apple.com/library/content/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/Art/hit_testing_2x.png" alt="Figure 2-1  Hit-testing returns the subview that was touched"></p>
<p>更形象点的例子。我们结合<code>Figure 2-1</code>图片来看</p>
<pre><code>1. 当点击手势位于view A。 我们要检查子视图view B 和view C
2. 点击手势没有位于view B，所以我们开始检查view C的子视图view D 和view E
3. 点击手势没有位于view D，所以点击手势被view E响应
</code></pre><p><code>hitTest:withEvent:</code> 跟<code>CGPoint</code>和<code>UIEvent</code>参数找到对应的<code>hit test view</code>。</p>
<p>The <code>hitTest:withEvent:</code> method returns the hit test view for a given CGPoint and UIEvent. The <code>hitTest:withEvent:</code> method begins by calling the <code>pointInside:withEvent:</code> method on itself. If the point passed into <code>hitTest:withEvent:</code> is inside the bounds of the view, <code>pointInside:withEvent:</code> returns YES. Then, the method recursively calls <code>hitTest:withEvent:</code> on every subview that returns YES.</p>
<p>If the point passed into <code>hitTest:withEvent:</code> is not inside the bounds of the view, the first call to the <code>pointInside:withEvent:</code> method returns NO, the point is ignored, and <code>hitTest:withEvent:</code> returns nil. If a subview returns NO, that whole branch of the view hierarchy is ignored, because if the touch did not occur in that subview, it also did not occur in any of that subview’s subviews. This means that any point in a subview that is outside of its superview can’t receive touch events because the touch point has to be within the bounds of the superview and the subview. This can occur if the subview’s clipsToBounds property is set to NO.</p>
<p>Note: A touch object is associated with its hit-test view for its lifetime, even if the touch later moves outside the view.<br>The hit-test view is given the first opportunity to handle a touch event. If the hit-test view cannot handle an event, the event travels up that view’s chain of responders as described in The Responder Chain Is Made Up of Responder Objects until the system finds an object that can handle it.</p>
<h2 id="The-Responder-Chain-Is-Made-Up-of-Responder-Objects"><a href="#The-Responder-Chain-Is-Made-Up-of-Responder-Objects" class="headerlink" title="The Responder Chain Is Made Up of Responder Objects"></a>The Responder Chain Is Made Up of Responder Objects</h2><p>我们再聊聊如果事件没有被消费掉怎么办？ </p>
<p>答案是: 事件会跟随响应链一级一级向上传递。最终给到 Application(继承自UIResponer)。</p>
<p>一个响应者对象(UIApplication/UIViewController/UIView)是能够响应和处理事件的。</p>
<p>第一响应者被设计为能第一个接受事件。要成为第一响应者，需要做以下两件事。</p>
<pre><code>1. 重写 canBecomeFirstResponder 返回YES
2. 处理 becomeFirstResponder 调用。 必要情况可以主动调用这个方法
</code></pre><p><strong>提示：</strong> becomeFirstResponder调用时机最好 在视图都准备到位之后。比如不要在<code>viewWillAppear</code>阶段。应该在<code>viewDidAppear</code>阶段在调用</p>
<p>响应者能处理的事件有：</p>
<pre><code>* 触摸事件(Touch Events): 如果`hit test view`没有消费这个事件。事件按照响应链被向上传递
* 运动事件(Motion Events): UIKit处理这个事件，第一响应者必须要实现` motionBegan:withEvent:` 或 `motionEnded:withEvent:`方法
* 遥控事件(Remote control events): 第一响应者必须实现` remoteControlReceivedWithEvent:`方法
* Action messages: 比如按钮啊、开关啊。如果接受者的action为nil，也会按照响应链向上传递事件
* Editing-menu messages.  
* Text editing. 用户点击输入框或文本视图，UIKit默认自动将其置为第一响应者。接着，模拟键盘被唤起，光标聚焦。
</code></pre><p>只有<code>Text Field</code>或<code>Text View</code>在用户点击之后，UIKit会自动将其置为第一响应者。其他的需要主动的调用<code>becomeFirstResponder</code>方法</p>
<p>响应链向上传递事件是有一些规则的。 看看以下图片的两种情况：</p>
<p><img src="https://developer.apple.com/library/content/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/Art/iOS_responder_chain_2x.png" alt="iOS_responder_chain"></p>
<p>左图：</p>
<pre><code>1. initial view不处理事件/消息，传递给父级view
2. 父级view接受到事件，不处理的话接着传递给父级view(viewController&apos;s view)
3. 父级view(viewController&apos;s view)接受到事件，不处理的话传递给viewController
4. viewController接收到事件，不处理传递给windows
5. windows接受到事件，不处理传递给 Application
6. 如果Application最后再不处理的话，事件就被忽略了。。
</code></pre><p>其中传递链路上任一响应者处理了事件，就中断传递了</p>
<p>右图：</p>
<pre><code>1. initial view不处理事件/消息，传递给父级view(viewController&apos;s view)
2. 父级view接受到事件，传递给viewController
3. viewController接受到事件，传递给父级view
    步骤1-3 重复直到找到rootViewController
4. rootViewController 传递给 windows
5. windows 传递给 Application
</code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://developer.apple.com/library/content/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/event_delivery_responder_chain/event_delivery_responder_chain.html" target="_blank" rel="external">Event Delivery: The Responder Chain</a></li>
<li><a href="http://smnh.me/hit-testing-in-ios/" target="_blank" rel="external">Hit-Testing in iOS</a></li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Responder-Chain/">Responder Chain</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-10-30-LeetCode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/30/2016-10-30-LeetCode/">LeetCode</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/10/30/2016-10-30-LeetCode/" class="article-date">
  <time datetime="2016-10-30T00:00:00.000Z" itemprop="datePublished">2016-10-30</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a><span>></span><a class="article-category-link" href="/categories/Algorithm/LeetCode/">LeetCode</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近整理了自己在LeetCode上所有<code>Accepted</code>的提交并开源在<a href="https://github.com/778477/LeetCode" target="_blank" rel="external">LeetCode-Solver</a></p>
<p>之前遇到有意思的题目，会专门写篇博客讲讲。现在感觉这要刷完leetcode不得上百篇了，没这必要。。所以后面计划把思路注释和代码写在一起。一并提交到leetcode上。</p>
<p>遇到可以用<code>Swift</code>的题目，也会使用<code>Swift</code>来练练手。解题代码还是多数使用<code>C/C++</code></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LeetCode/">LeetCode</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-10-24-QCon2016上海站见闻" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/24/2016-10-24-QCon2016上海站见闻/">QCon 2016 上海站见闻</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/10/24/2016-10-24-QCon2016上海站见闻/" class="article-date">
  <time datetime="2016-10-24T00:00:00.000Z" itemprop="datePublished">2016-10-24</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/QCon/">QCon</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>有幸参与了QCon 2016的上海站会议。官方宣传这是一个中高端会议，专题丰富涵盖了当前互联网各种技术领域。</p>
<table>
<thead>
<tr>
<th>10月20号周四</th>
<th style="text-align:center">10月21号周五</th>
<th style="text-align:right">10月22号周五</th>
</tr>
</thead>
<tbody>
<tr>
<td>前端技术实践</td>
<td style="text-align:center">玩转大数据</td>
<td style="text-align:right">Growth Hacking，IoT &amp; React Native</td>
</tr>
<tr>
<td>安全之战</td>
<td style="text-align:center">移动开发探索</td>
<td style="text-align:right">互联网广告系统实战</td>
</tr>
<tr>
<td>新Java，新未来</td>
<td style="text-align:center">移动视频</td>
<td style="text-align:right">工程团队管理</td>
</tr>
<tr>
<td>无处不在的容器</td>
<td style="text-align:center">让架构更简单</td>
<td style="text-align:right">技术创业</td>
</tr>
<tr>
<td>微服务架构，我们该如何实践？</td>
<td style="text-align:center">运维与监控</td>
<td style="text-align:right">机器学习与深度学习</td>
</tr>
<tr>
<td>大数据应用与系统优化实践(厂商共建专题)</td>
<td style="text-align:center">大数据服务与应用</td>
<td style="text-align:right">用户体验设计</td>
</tr>
<tr>
<td>业务上云技术拆解(厂商共建专题)</td>
<td style="text-align:center">高并发与实时处理架构设计(厂商共建专题)</td>
<td style="text-align:right">研发支撑体系</td>
</tr>
<tr>
<td>智能出行 - 高德开放平台专场(厂商共建专题)</td>
<td style="text-align:center">微服务实践与架构演进之路(厂商共建专题)</td>
<td style="text-align:right">业务系统架构</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:right">大数据分析与应用</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:right">大规模前端系统</td>
</tr>
</tbody>
</table>
<p><a href="http://ppt.geekbang.org/qconsh2016" target="_blank" rel="external">QCon 上海站PPT 下载</a></p>
<p>其中每个专题会在固定的宴会厅进行，由专题出品人主持专题的会议开展。专题下面是各个议题，时长大致为45分钟包含Q&amp;A环节。</p>
<p>根据自身技术栈出发，我选择了以下专题</p>
<ul>
<li>20号 前端技术实践</li>
<li>21号 移动开发探索</li>
<li>22号 Growth Hacking &amp; 用户体验设计 &amp; 技术创业</li>
</ul>
<h2 id="前端技术实践"><a href="#前端技术实践" class="headerlink" title="前端技术实践"></a>前端技术实践</h2><p>周四的专题对于 客户端开发来说稍显尴尬，没有与之相关的议题。 我选择了和客户端相对平等的前端专题。 下面重点介绍一下我认为有意思的议题：</p>
<h3 id="Vue-2-0-渐进式前端解决方案"><a href="#Vue-2-0-渐进式前端解决方案" class="headerlink" title="Vue 2.0: 渐进式前端解决方案"></a>Vue 2.0: 渐进式前端解决方案</h3><p>讲师@尤雨溪，很早就关注他了。这次总算见到真人了。<a href="https://github.com/vuejs/vue" target="_blank" rel="external">Vue</a>已经在Github上收获了3w+颗star，对于开源项目来说，无疑是相当成功了。</p>
<p>我很认同他对框架的理解。<strong>框架的存在是为了帮助我们应对复杂度。但同时框架也有复杂度，Pick the right tool for the job.</strong></p>
<p>开篇的框架理解引出了 Vue ，这个渐进式前端解决方案。可能就是他对当下JS开发环境的一个答案。</p>
<p>框架本身，我不是JS开发，没有使用经历就不做主观评价了。 回到一开始的”框架”，他是如何解决框架复杂度的呢？ 答案是”渐进式”。</p>
<p><img src="https://github.com/778477/778477.github.io/blob/51ed1eda4322c046a4bfe958f96dfcb3c744f7ec/img/Vue-Progressive.png?raw=true" alt="progressive"></p>
<p>Vue框架提供 声明式渲染 核心功能，加上可选的附加库/工具链，来打造弹性复杂度。这个区别于传统框架，集成整合了一整套解决方案。提高框架复杂度，增加开发者的学习使用成本。</p>
<p>这种框架的设计思路，是明智的。</p>
<h3 id="Progressive-Web-App：反击序章"><a href="#Progressive-Web-App：反击序章" class="headerlink" title="Progressive Web App：反击序章"></a>Progressive Web App：反击序章</h3><p>讲师@黄玄开篇讲述了web在当下移动时代的窘境。有一定的技术高度看待这类行业问题是蛮赞的。不认可web在移动时代只有Hybrid这一种选择。</p>
<p>开始布道 PWA(Progressive Web App),认为这是web针对native的一次反击。<br><strong>The new application model for Web</strong></p>
<ul>
<li>add To HomeScreen (web 也有像native原生应用一样的桌面图标入口)</li>
<li>Instant Loading &amp; ReliableExperience (提供一种缓存机制，类似原生应用的首次下载)</li>
<li>Push Notifications (web 也可以像原生应用一样接受通知)</li>
</ul>
<p>…等等一些特性。让我这种native同学感到十分新鲜。确实<strong>在 纯web 到 纯navite 之间有许多可能的点</strong>。</p>
<p>反观业界，应该很少有企业对自己的网站能支持到这种体验程度。特别是在iOS 9提供了 web mark机制之后，直接把web流量切给了native。不知道有没有统计过用户是愿意留在浏览器 还是 更愿意跳往原生应用</p>
<p>不过在原生应用开发实践中，我个人偏向于 hybrid 方案。这个取决于你的App大多数是什么样的业务场景，需要权衡体验和发布节奏等利益点。</p>
<ol>
<li>纯native，体验是有可以保证的。 缺点就是发版受限</li>
<li>hybrid，这里讨论指的是 RN，Weex这种跨端方案。好处是 发布不受限制，一人开发跨两端(iOS,Android) 节省人力。体验稍逊于native</li>
<li>纯web，包括不经优化，直接套用webview的这种。缺点是体验差，卡顿，load时间久</li>
</ol>
<h2 id="移动开发探索"><a href="#移动开发探索" class="headerlink" title="移动开发探索"></a>移动开发探索</h2><p>这个专题与我息息相关，吸引的我是这些议题</p>
<h3 id="React-Native-业务实践和性能优化"><a href="#React-Native-业务实践和性能优化" class="headerlink" title="React Native 业务实践和性能优化"></a>React Native 业务实践和性能优化</h3><p><img src="https://github.com/778477/778477.github.io/blob/c35a39b54f811e27512715841869cb6dd1b1ca2c/img/who%20use%20RN.png?raw=true" alt="who use RN"></p>
<p>讲师 携程@赵辛贵。 携程积极拥抱RN技术，多数业务和页面使用RN搭建。<br>好处明显</p>
<ul>
<li>size优势，RN页面大小计算脱离原生包大小</li>
<li>支持动态发布，跨端节省开发人力</li>
<li>RN技术成熟，社区活跃(参会时和旁边的途牛网开发交流，他们动态方案也是选择RN)</li>
</ul>
<p>携程内部还演化出了CRN(ctrip RN)业务框架。做了性能和稳定性优化(思路参见PPT)，规划支持CRN-web实现跨三端(iOS,android,H5)。</p>
<p>外界RN动态方案使用的如火如荼，他们正在证明这是未来移动前端开发的方向。</p>
<h3 id="Weex-极致性能优化"><a href="#Weex-极致性能优化" class="headerlink" title="Weex 极致性能优化"></a>Weex 极致性能优化</h3><p>公司同学分享，Weex性能优化的几个思路方向。围绕性能，干货较多。<br>不过，这种经历只能听听思路。 基本没有实践复用场景 ：）<br>安利Weex性能很好，倒是真的。</p>
<h3 id="蘑菇街-App-的稳定性与性能实践"><a href="#蘑菇街-App-的稳定性与性能实践" class="headerlink" title="蘑菇街 App 的稳定性与性能实践"></a>蘑菇街 App 的稳定性与性能实践</h3><p>从用户角度出发看 性能和稳定性问题：</p>
<ul>
<li>闪退</li>
<li>打开慢</li>
<li>滑动不流畅</li>
<li>耗电</li>
<li>网络不畅/出错</li>
<li>流量大</li>
</ul>
<p>都是客户端常见的问题，相信各大公司都有自己的答案实践。</p>
<p>他们有一个比较有意思的工具：AppMate(小蘑菇) 提供给测试和业务开发进行开发阶段的一个性能把控。</p>
<p>或许是在阿里的原因，这些东西听来都不足以让我兴奋。</p>
<h2 id="Growth-Hacking-最新动态和最佳实践"><a href="#Growth-Hacking-最新动态和最佳实践" class="headerlink" title="Growth Hacking 最新动态和最佳实践"></a>Growth Hacking 最新动态和最佳实践</h2><p>这个是受团队运营产品委托，刻意留意了这个议题(我所在的天猫team也负责push通道来召回用户，提高留存)</p>
<h3 id="Growth-Hacking-最新动态和最佳实践-1"><a href="#Growth-Hacking-最新动态和最佳实践-1" class="headerlink" title="Growth Hacking 最新动态和最佳实践"></a>Growth Hacking 最新动态和最佳实践</h3><ol>
<li>数据看板 - 数据分析 - 数据监控 </li>
<li>数据驱动产品决策</li>
<li>AB 测试实验</li>
<li>灰度渠道发布</li>
</ol>
<p>其中的数据分析提到：”Core Action” 指到的是核心操作，关键路径到达。<br>列举了几类APP的”Core Action”</p>
<table>
<thead>
<tr>
<th>APP类型</th>
<th style="text-align:center">Core Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>Facebook</td>
<td style="text-align:center">connect(连接？相互关注？朋友互动？)</td>
</tr>
<tr>
<td>Slack/Wechat</td>
<td style="text-align:center">接发信息</td>
</tr>
<tr>
<td>Pinterest</td>
<td style="text-align:center">晒图</td>
</tr>
<tr>
<td>电商</td>
<td style="text-align:center">浏览、下单购买</td>
</tr>
<tr>
<td>知乎</td>
<td style="text-align:center">回答，点赞，收藏，感谢</td>
</tr>
<tr>
<td>互联网金融</td>
<td style="text-align:center">购买理财产品</td>
</tr>
<tr>
<td>二手车</td>
<td style="text-align:center">购买，砍价</td>
</tr>
</tbody>
</table>
<p>这里有一个观点 <strong>重点关心产品核心操作是否被用户触达</strong><br><img src="https://github.com/778477/778477.github.io/blob/ab7afbca4d9a27b303743598400c76fa1651c367/img/growth-push-recall.png?raw=true" alt="recall"><br>这个模型 描述了 新客或流失客户(最近打开app的时候是在30-60天之前)，我们应该积极的通过Push通道来进行用户召回，当用户下沉为忠实用户之后。要谨慎使用push。这个模型是可逆的，也就是说当用户不再活跃的时候，回归上层我们也要通过push相关利益点来进行召回。</p>
<p>分享了业界做病毒式扩散的几个经典例子：</p>
<ol>
<li>airbnb 分享给朋友，两方都能获得25刀的优惠券</li>
<li>PRISMA 图片滤镜软件 制作图片打上软件水印</li>
<li>Pokémon Go 户外现象级户外捕捉小精灵</li>
</ol>
<p>这些快速扩散区别于 用户推荐和口口相传。分享者和你分享的时候，并不是在说这个平台或者软件如何如何，还是在和你分享他们得到了什么。分享一定要满足用户一些心理：增加声望、财富、乐趣。</p>
<p>最后病毒式扩散一定要作用在Core Action上。</p>
<h3 id="产品思维和设计思维详解"><a href="#产品思维和设计思维详解" class="headerlink" title="产品思维和设计思维详解"></a>产品思维和设计思维详解</h3><p>讲师 @张玉婷，她的设计思路蛮不错的。她认为设计师设计产品交互的时候，一定是从产品架构出发分析产品用户需求，进而推导出产品界面。而不是接到需求在网上一通翻找竞品界面。不同的需求场景有不同的用户语境，进而有不同的视觉交互表达。</p>
<p>比如 从业参与的Weico客户端，是设计驱动的一个产品。目前是最大的微博第三方客户端，跳脱开 官方微博客户端的通用性和功能化，主打个性化和情感化。围绕核心功能(阅读和发送微博)进行 特色的设计扩展。</p>
<p>后面提及高德客户端的交互设计，虽然 App类型不同，设计很难参考。但思路是ok的。要关注 用户与产品发生交互的真实场景，介绍了高德在这方面的交互实践。</p>
<h3 id="如何选好技术初创风口：从0到1，1到100"><a href="#如何选好技术初创风口：从0到1，1到100" class="headerlink" title="如何选好技术初创风口：从0到1，1到100"></a>如何选好技术初创风口：从0到1，1到100</h3><p>这个。实话说我睡着了，可能是吃完中饭乏了。恩，是的。</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QCon-上海2016/">QCon 上海2016</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-10-03-Gas Station" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/03/2016-10-03-Gas Station/">Gas Station</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/10/03/2016-10-03-Gas Station/" class="article-date">
  <time datetime="2016-10-03T00:00:00.000Z" itemprop="datePublished">2016-10-03</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a><span>></span><a class="article-category-link" href="/categories/Algorithm/LeetCode/">LeetCode</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://leetcode.com/problems/gas-station/" target="_blank" rel="external">LeetCode - 134.Gas Station</a></p>
<h2 id="题目大意："><a href="#题目大意：" class="headerlink" title="题目大意："></a>题目大意：</h2><p>有<code>n</code>个加油站分布在 环形路线上。其中每个加油站的储油量为 <code>gas[i]</code>。 你有一辆巨大油箱(可以无限加油)的汽车,从 站点<code>i</code>到下一站<code>i+1</code>，油耗为 <code>cost[i]</code>。一开始的时候，汽车油箱是空的。</p>
<p>如果你能一次开完全程的话，请返回一个起始站点。否则返回-1表示无法完成。</p>
<ul>
<li><p>提示： 测试用例保证答案是唯一的。</p>
</li>
<li><p>疑问：题目未明显指出 是顺时针开或逆时针开。但从测试数据理解 站点i 到 站点i+1，应该是顺时针开的。</p>
</li>
</ul>
<h2 id="解题思路："><a href="#解题思路：" class="headerlink" title="解题思路："></a>解题思路：</h2><p>首先可以明确的是，如果 总油耗<code>sum{cost[0...n]}</code> 大于 总储量<code>sum{gas[0...n]}</code>的话，是无法完成任务的。直接返回-1。</p>
<p>接着，思考一下当 总油耗 小等于 总储量时，是否必然存在可行解。</p>
<p> C(i) + C(i+1) + C(i+2) + C(i+3) … + C(i+n) = C</p>
<p> G(i) + G(i+1) + G(i+2) + G(i+3) … + G(i+n) = G</p>
<p> G &gt;= C</p>
<p> 如果 平均分布的话， 则 G(i)&gt;=C(i) 。 必然是ok的。</p>
<p> 考虑极限情况，C(i) 油耗巨大。贪心策略保证每站必停(油不加白不加)，我们从i站点<code>逆时针</code>选点。基于贪心考虑，逆时针选站点要保证对经过C(i)最大油耗是有利：每一次后退选点对总油耗是正向的。</p>
<h2 id="枚举-Time-Limit-Exceeded"><a href="#枚举-Time-Limit-Exceeded" class="headerlink" title="枚举 (Time Limit Exceeded)"></a>枚举 (Time Limit Exceeded)</h2><p>时间复杂度 大致为 O(n^2)。 测试用例数据极为暴力。。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">goRound</span><span class="params">(<span class="keyword">int</span> starInx,<span class="keyword">int</span> *gas,<span class="keyword">int</span> gasSize,<span class="keyword">int</span> *cost,<span class="keyword">int</span> costSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nowGas = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> nowIdx = starInx;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;gasSize;i++)&#123;</span><br><span class="line">        nowGas += gas[nowIdx];</span><br><span class="line">        <span class="keyword">if</span>(nowGas &lt; cost[nowIdx]) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        nowGas -= cost[nowIdx];</span><br><span class="line">        nowIdx = (nowIdx+<span class="number">1</span>)%gasSize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> nowGas &gt;= <span class="number">0</span> ? starInx : <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">canCompleteCircuit</span><span class="params">(<span class="keyword">int</span>* gas, <span class="keyword">int</span> gasSize, <span class="keyword">int</span>* cost, <span class="keyword">int</span> costSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> totalGas = <span class="number">0</span>, totalCosts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;costSize;i++)&#123;</span><br><span class="line">        totalCosts += cost[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;gasSize;i++)&#123;</span><br><span class="line">        totalGas += gas[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(totalGas &lt; totalCosts) <span class="keyword">return</span> ans;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;gasSize;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((ans = goRound(i,gas,gasSize,cost,costSize)) != <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="贪心-Accepted"><a href="#贪心-Accepted" class="headerlink" title="贪心 (Accepted)"></a>贪心 (Accepted)</h2> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">canCompleteCircuit</span><span class="params">(<span class="keyword">int</span>* gas, <span class="keyword">int</span> gasSize, <span class="keyword">int</span>* cost, <span class="keyword">int</span> costSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> totalGas = <span class="number">0</span>, totalCosts = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> maxCostIdx = <span class="number">-1</span>, maxCost = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;costSize;i++)&#123;</span><br><span class="line">        totalCosts += cost[i];</span><br><span class="line">        <span class="keyword">if</span>(cost[i] &gt; maxCost)&#123;</span><br><span class="line">            maxCostIdx = i;</span><br><span class="line">            maxCost = cost[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;gasSize;i++)&#123;</span><br><span class="line">        totalGas += gas[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(totalGas &lt; totalCosts) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> tmp = maxCostIdx;</span><br><span class="line">    <span class="keyword">int</span> tmpMaxgas = gas[tmp];</span><br><span class="line">    <span class="keyword">int</span> tmpMaxCost = cost[tmp];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (tmpMaxgas &lt; tmpMaxCost || gas[tmp] &gt;= cost[tmp]) &#123; <span class="comment">// 贪心策略</span></span><br><span class="line">        tmp--;</span><br><span class="line">        <span class="keyword">if</span>(tmp == <span class="number">-1</span>) tmp = gasSize - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(tmp == maxCostIdx) <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        tmpMaxgas += gas[tmp];</span><br><span class="line">        tmpMaxCost += cost[tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (tmp+<span class="number">1</span>)%gasSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <img src="https://raw.githubusercontent.com/778477/778477.github.io/baa6788ce066521a1d0c315c37894e4791c99f55/img/gas-station.png" alt="Accepted"></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LeetCode/">LeetCode</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-09-22-SDWebImage读码笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/22/2016-09-22-SDWebImage读码笔记/">SDWebImage 读码笔记</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/09/22/2016-09-22-SDWebImage读码笔记/" class="article-date">
  <time datetime="2016-09-22T00:00:00.000Z" itemprop="datePublished">2016-09-22</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a><span>></span><a class="article-category-link" href="/categories/iOS/读码笔记/">读码笔记</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <table>
<thead>
<tr>
<th>Watch</th>
<th style="text-align:left">Star</th>
<th style="text-align:left">Fork</th>
<th style="text-align:left">Open Issues</th>
<th style="text-align:left">Closed Issue</th>
</tr>
</thead>
<tbody>
<tr>
<td>823</td>
<td style="text-align:left">15711</td>
<td style="text-align:left">4432</td>
<td style="text-align:left">133</td>
<td style="text-align:left">1021</td>
</tr>
</tbody>
</table>
<p>从 Star 和 Issue 维度来看SDWebImage可谓是万众瞩目和久经考验。 </p>
<p><a href="https://github.com/rs/SDWebImage/blob/master/README.md" target="_blank" rel="external">SDWebImage-README</a></p>
<p><a href="https://github.com/rs/SDWebImage/wiki/How-is-SDWebImage-better-than-X%3F" target="_blank" rel="external">How is SDWebImage better than X?</a></p>
<p>下面，我们来细致的阅读一下 SDWebImage(简称 SD)的源码。 </p>
<h1 id="一些良好的编码习惯"><a href="#一些良好的编码习惯" class="headerlink" title="一些良好的编码习惯"></a>一些良好的编码习惯</h1><ul>
<li><p>SD的扩展命名风格不错。 带有sd_ 下划线前缀以此来区分是否为 三方库扩展。避免 扩展方法重名 覆盖问题。</p>
<ol>
<li>同样的命名风格适用于 类名。前缀可以避免OC语言没有命名空间的尴尬。 </li>
<li>不过需要注意的是，Cocoa应用程序Apple宣称拥有”两字母前缀”的权利。 所以有可能在不远的将来，SD要面临 命名冲突的问题。</li>
</ol>
</li>
<li><p>对于SD废弃的方法。 SD的做法是 将方法移至 对应的<code>Deprecated</code>中。 并在方法申明的时候给出提示。这种做法，笔者也比较认同。 SDK对外的接口变更是不可避免的。在版本更新中直接删除的话，会让依赖方有改造成本。对废弃方法进行警告声明，实现上调用新方法是比较优雅和无害的。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@interface UIImageView (WebCacheDeprecated)</span><br><span class="line">- (NSURL *)imageURL __deprecated_msg(&quot;Use `sd_imageURL`&quot;);</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<ul>
<li><p>使用类型常量。 Effective Objective-C 2.0 中的第四条实践。</p>
<p><code>SDWebImageCompat.h</code> </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern NSString *const SDWebImageErrorDomain;</span><br></pre></td></tr></table></figure>
<p><code>SDWebImageCompat.m</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSString *const SDWebImageErrorDomain = @&quot;SDWebImageErrorDomain&quot;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>使用inline 内联函数关键词。 inline这个关键词会<strong>建议</strong>编译器内联展开处理。inline这个关键词在C++上出场频率比较高。 关于<a href="http://www.sunistudio.com/cppfaq/inline-functions.html" target="_blank" rel="external">inline关键词的QA</a> 具体的性能影响可以看[9.3]。 <strong>笔者认为 inline仅适用于调用频繁的短函数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> inline UIImage *SDScaledImageForKey(NSString *key, UIImage *image) &#123;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> FOUNDATION_STATIC_INLINE NSUInteger SDCacheCostForImage(UIImage *image) &#123;</span><br><span class="line">    return image.size.height * image.size.width * image.scale * image.scale;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> <a href="http://www.cnblogs.com/cnmaizi/archive/2011/01/19/1939686.html" target="_blank" rel="external">关于inline的扩展阅读</a> </p>
<ul>
<li>使用 <code>dispatch_barrier_sync</code> 来保证一些多线程操作的原子性。 笔者也做过一些 <a href="https://github.com/778477/iOS-Lock-BenchMarking" target="_blank" rel="external">iOS 锁的branchMarking</a></li>
</ul>
<h1 id="关于SDWebImage图片下载实现的细节"><a href="#关于SDWebImage图片下载实现的细节" class="headerlink" title="关于SDWebImage图片下载实现的细节"></a>关于SDWebImage图片下载实现的细节</h1><ul>
<li>如何识别 图片格式？ 是jpg，png还是gif呢？ SD的 NSData扩展方法可以告诉你。根据图片的具体数据内容，可以看出对应的格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSData (ImageContentType)</span><br><span class="line"></span><br><span class="line">+ (NSString *)sd_contentTypeForImageData:(NSData *)data &#123;</span><br><span class="line">    uint8_t c;</span><br><span class="line">    [data getBytes:&amp;c length:1];</span><br><span class="line">    switch (c) &#123;</span><br><span class="line">        case 0xFF:</span><br><span class="line">            return @&quot;image/jpeg&quot;;</span><br><span class="line">        case 0x89:</span><br><span class="line">            return @&quot;image/png&quot;;</span><br><span class="line">        case 0x47:</span><br><span class="line">            return @&quot;image/gif&quot;;</span><br><span class="line">        case 0x49:</span><br><span class="line">        case 0x4D:</span><br><span class="line">            return @&quot;image/tiff&quot;;</span><br><span class="line">        case 0x52:</span><br><span class="line">            // R as RIFF for WEBP</span><br><span class="line">            if ([data length] &lt; 12) &#123;</span><br><span class="line">                return nil;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            NSString *testString = [[NSString alloc] initWithData:[data subdataWithRange:NSMakeRange(0, 12)] encoding:NSASCIIStringEncoding];</span><br><span class="line">            if ([testString hasPrefix:@&quot;RIFF&quot;] &amp;&amp; [testString hasSuffix:@&quot;WEBP&quot;]) &#123;</span><br><span class="line">                return @&quot;image/webp&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<ul>
<li>SD 缓存中的图片是 原始的，未解压的。</li>
</ul>
<blockquote>
<p>On the other side, SDWebImage caches the UIImage representation in memory and store the original compressed (but decoded) image file on disk. UIImage are stored as-is in memory using NSCache, so no copy is involved, and memory is freed as soon as your app or the system needs it.</p>
<p>Additionally, image decompression that normally happens in the main thread the first time you use UIImage in an UIImageView is forced in a background thread by SDWebImageDecoder.</p>
</blockquote>
<p>关于 图片的解压，可以查看<code>SDWebImageDecoder</code>的实现。 SD有对应<code>shouldDecompressImages</code>功能开关。默认是开启的。</p>
<p><a href="https://github.com/rs/SDWebImage/issues/1173" target="_blank" rel="external">What does SDWebImageDecoder do? #1173</a></p>
<h1 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h1><p><img src="https://raw.githubusercontent.com/778477/778477.github.io/master/img/SDWebImage.png" alt=""></p>
<h2 id="step-3"><a href="#step-3" class="headerlink" title="step. 3"></a>step. 3</h2><p>因为，SD实现了自己的图片缓存机制。所以，在下载流程中，SD会先检查一遍是否命中缓存。<br>SD的图片缓存key 为<code>url.absoluteString</code>，SD还有一个<code>缓存筛选机制</code>，用来支持删除 图片url动态变更的部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageManager.h</span><br><span class="line">@property (nonatomic, copy) SDWebImageCacheKeyFilterBlock cacheKeyFilter;</span><br></pre></td></tr></table></figure>
<p>这个机制会作用于所有<code>cache key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)cacheKeyForURL:(NSURL *)url &#123;</span><br><span class="line">    if (!url) &#123;</span><br><span class="line">        return @&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (self.cacheKeyFilter) &#123;</span><br><span class="line">        return self.cacheKeyFilter(url);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return [url absoluteString];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Cache</code>实现部分参见<code>SDImageCache.h</code>。</p>
<ul>
<li>内存缓存部分，SD是使用<code>NSCahce</code></li>
<li><p>磁盘缓存部分，SD是读写文件操作</p>
<p>缓存部分，并无新意。<code>IO</code>注意异步线程操作即可。SD监听了应用 <code>DidReceiveMemoryWarning</code>，<code>WillTerminate</code>，<code>DidEnterBackground</code>等消息来处理自己的缓存，让缓存存储较为得体。应用内部缓存大小不影响宿主环境。</p>
<p><code>- (void)storeImage:(UIImage *)image recalculateFromImage:(BOOL)recalculate imageData:(NSData *)imageData forKey:(NSString *)key toDisk:(BOOL)toDisk</code> 中有一段代码挺有意思的。 SD的磁盘缓存是写入<code>imageData</code>，一般下载结束之后，SD是能拿到<code>image</code> 和 <code>imageData</code>的。 但如果只有<code>image</code>呢？ 磁盘缓存该如何写入？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> if (image &amp;&amp; (recalculate || !data)) &#123;</span><br><span class="line">#if TARGET_OS_IPHONE</span><br><span class="line">                // We need to determine if the image is a PNG or a JPEG</span><br><span class="line">                // PNGs are easier to detect because they have a unique signature (http://www.w3.org/TR/PNG-Structure.html)</span><br><span class="line">                // The first eight bytes of a PNG file always contain the following (decimal) values:</span><br><span class="line">                // 137 80 78 71 13 10 26 10</span><br><span class="line"></span><br><span class="line">                // If the imageData is nil (i.e. if trying to save a UIImage directly or the image was transformed on download)</span><br><span class="line">                // and the image has an alpha channel, we will consider it PNG to avoid losing the transparency</span><br><span class="line">                int alphaInfo = CGImageGetAlphaInfo(image.CGImage);</span><br><span class="line">                BOOL hasAlpha = !(alphaInfo == kCGImageAlphaNone ||</span><br><span class="line">                                  alphaInfo == kCGImageAlphaNoneSkipFirst ||</span><br><span class="line">                                  alphaInfo == kCGImageAlphaNoneSkipLast);</span><br><span class="line">                BOOL imageIsPng = hasAlpha;</span><br><span class="line"></span><br><span class="line">                // But if we have an image data, we will look at the preffix</span><br><span class="line">                if ([imageData length] &gt;= [kPNGSignatureData length]) &#123;</span><br><span class="line">                    imageIsPng = ImageDataHasPNGPreffix(imageData);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (imageIsPng) &#123;</span><br><span class="line">                    data = UIImagePNGRepresentation(image);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    data = UIImageJPEGRepresentation(image, (CGFloat)1.0);</span><br><span class="line">                &#125;</span><br><span class="line">#else</span><br><span class="line">                data = [NSBitmapImageRep representationOfImageRepsInArray:image.representations usingType: NSJPEGFileType properties:nil];</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>通过 是否有<code>alpha</code>通道 和 <code>ImageDataHasPNGPreffix</code> 来判断<code>image</code>类型，进而使用API进行<code>UIimage to NSData</code>。</p>
<h2 id="step-4"><a href="#step-4" class="headerlink" title="step. 4"></a>step. 4</h2><p>SD的下载核心逻辑是在<code>SDWebImageDownloader</code>。<code>Downloader</code>维护着一个线程池，控制<code>SDWebImageDownloaderOperation</code>最小单元下载任务。</p>
<ul>
<li>默认并发下载量为6。可以通过<code>maxConcurrentDownloads</code>修改。</li>
<li>下载超时时限默认为15.0。 可以通过<code>downloadTimeout</code>修改。</li>
<li>下载任务执行顺序策略有 <code>SDWebImageDownloaderFIFOExecutionOrder (队列等待，默认方式)</code> 和 <code>SDWebImageDownloaderLIFOExecutionOrder (栈等待)</code></li>
</ul>
<p><code>Downloader</code>实现<code>NSURLSessionDataDelegate</code>协议，并将回调派发给具体的<code>DownloaderOperation</code>来响应下载各个阶段的数据回调。</p>
<p><code>DownloaderOperation</code>继承自<code>NSOperation</code>并实现<code>SDWebImageOperation</code>。都是为了保证下载任务能被<code>cancel</code>。<code>cancel</code>对应一个任务而言是很重要的。因为继承自<code>NSOperation</code>，所以SD在cancel部分的实现也很简单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (void)cancel &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (self.thread) &#123;</span><br><span class="line">            [self performSelector:@selector(cancelInternalAndStop) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            [self cancelInternal];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cancelInternalAndStop &#123;</span><br><span class="line">    if (self.isFinished) return;</span><br><span class="line">    [self cancelInternal];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cancelInternal &#123;</span><br><span class="line">    if (self.isFinished) return;</span><br><span class="line">    [super cancel];</span><br><span class="line">    if (self.cancelBlock) self.cancelBlock();</span><br><span class="line"></span><br><span class="line">    if (self.dataTask) &#123;</span><br><span class="line">        [self.dataTask cancel];</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStopNotification object:self];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // As we cancelled the connection, its callback won&apos;t be called and thus won&apos;t</span><br><span class="line">        // maintain the isFinished and isExecuting flags.</span><br><span class="line">        if (self.isExecuting) self.executing = NO;</span><br><span class="line">        if (!self.isFinished) self.finished = YES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [self reset];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保证<code>cancel</code>操作的原子性，调用<code>[super cancel]</code> 和 将内置的<code>[self.dataTask cancel]</code>。重置一些状态位即可。 </p>
<p>SD的下载逻辑实现还是写的比较精彩的。清晰和严谨，不愧是“久经考验”</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>SD还有<code>SDWebImagePrefetcher</code>模块。顾名思义，<code>Prefetcher</code>就是预下载逻辑。提前拉取图片资源，等到用的时候直接取用本地资源。<code>本地IO</code>速度快于<code>网络IO</code>，是一种优化思路。</p>
<p>查看SD源码时，一些查阅的链接。 有些启发，在这里记录一下。</p>
<p><a href="https://developer.apple.com/library/content/documentation/GraphicsImaging/Conceptual/ImageIOGuide/imageio_intro/ikpg_intro.html#//apple_ref/doc/uid/TP40005462-CH201-TPXREF101" target="_blank" rel="external">Image I/O Programming Guide</a></p>
<p><a href="http://www.fantageek.com/2015/06/18/understanding-sdwebimage-decompression/" target="_blank" rel="external">Understanding SDWebImage - Decompression</a></p>
<p><a href="http://pulkitgoyal.in/resizing-high-resolution-images-on-ios-without-memory-issues/" target="_blank" rel="external">Resizing High Resolution Images on iOS Without Memory Issues</a></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SDWebImage/">SDWebImage</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-2016-09-01-iOS 包瘦身研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/01/2016-09-01-iOS 包瘦身研究/">iOS 包瘦身浅析</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/09/01/2016-09-01-iOS 包瘦身研究/" class="article-date">
  <time datetime="2016-09-01T00:00:00.000Z" itemprop="datePublished">2016-09-01</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么要做包瘦身"><a href="#为什么要做包瘦身" class="headerlink" title="为什么要做包瘦身?"></a>为什么要做包瘦身?</h2><blockquote>
<p>Your app’s total uncompressed size must be less than 4 billion bytes. Each Mach-O executable file (for example, app_name.app/app_name) must not exceed these limits:</p>
<p>For apps whose MinimumOSVersion is less than 7.0: maximum of 80 MB for the total of all __TEXT sections in the binary.</p>
<p>For apps whose MinimumOSVersion is 7.x through 8.x: maximum of 60 MB per slice for the __TEXT section of each architecture slice in the binary.</p>
<p>For apps whose MinimumOSVersion is 9.0 or greater: maximum of 400 MB for the size of the Mach-O binary file.</p>
</blockquote>
<p><strong> Apple 对上架App 是有包大小限制的。超过这个限制，是无法提交审核的。 </strong></p>
<blockquote>
<p>However, consider download times when determining your app’s size. Minimize the file’s size as much as possible, keeping in mind that there is a 100 MB limit for over-the-air downloads.</p>
</blockquote>
<p><strong> 尽可能控制包大小， 超过100MB的App 是不会被自动更新到用户手机上 </strong></p>
<h2 id="如何分析可执行文件的大小"><a href="#如何分析可执行文件的大小" class="headerlink" title="如何分析可执行文件的大小"></a>如何分析可执行文件的大小</h2><p>AppStore 上传的包大小 =  资源文件大小 + 可执行文件大小</p>
<p>资源文件大小 显而易见。 但可执行文件由 具体的(.h/.m/.swift)文件编译链接而成。这个光是看代码文件大小是衡量不出来的。</p>
<p>这个时候就要介绍一下LinkMap了。 Xcode的LinkMap文件。LinkMap文件是Xcode产生可执行文件的同时生成的链接信息，用来描述可执行文件的构造成分，包括代码段<code>__TEXT</code>和数据段<code>__DATA</code>的分布情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># Sections:</span><br><span class="line"># Address	Size    	Segment	Section</span><br><span class="line">0x100002680	0x02DAED20	__TEXT	__text</span><br><span class="line">0x102DB13A0	0x00002FAC	__TEXT	__stubs</span><br><span class="line">0x102DB434C	0x00004DC2	__TEXT	__stub_helper</span><br><span class="line">0x102DB9110	0x00172C10	__TEXT	__gcc_except_tab</span><br><span class="line">0x102F2BD20	0x001DC91A	__TEXT	__objc_methname</span><br><span class="line">0x10310863A	0x00039CC2	__TEXT	__objc_classname</span><br><span class="line">0x1031422FC	0x00057D8E	__TEXT	__objc_methtype</span><br><span class="line">0x10319A090	0x00229C39	__TEXT	__cstring</span><br><span class="line">0x1033C3CD0	0x00025194	__TEXT	__ustring</span><br><span class="line">0x1033E8E80	0x000CC108	__TEXT	__const</span><br><span class="line">0x1034B4F88	0x000002C0	__TEXT	__swift2_proto</span><br><span class="line">0x1034B5248	0x000003E6	__TEXT	__entitlements</span><br><span class="line">0x1034B5630	0x00099AC8	__TEXT	__unwind_info</span><br><span class="line">0x10354F0F8	0x000AAED0	__TEXT	__eh_frame</span><br><span class="line">0x1035FA000	0x00000010	__DATA	__nl_symbol_ptr</span><br><span class="line">0x1035FA010	0x00002558	__DATA	__got</span><br><span class="line">0x1035FC568	0x00003F90	__DATA	__la_symbol_ptr</span><br><span class="line">0x1036004F8	0x000002E0	__DATA	__mod_init_func</span><br><span class="line">0x1036007E0	0x00103990	__DATA	__const</span><br><span class="line">0x103704170	0x00123460	__DATA	__cfstring</span><br><span class="line">0x1038275D0	0x00012130	__DATA	__objc_classlist</span><br><span class="line">0x103839700	0x00000328	__DATA	__objc_nlclslist</span><br><span class="line">0x103839A28	0x000016A8	__DATA	__objc_catlist</span><br><span class="line">0x10383B0D0	0x00000128	__DATA	__objc_nlcatlist</span><br><span class="line">0x10383B1F8	0x00002B68	__DATA	__objc_protolist</span><br><span class="line">0x10383DD60	0x00000008	__DATA	__objc_imageinfo</span><br><span class="line">0x10383DD68	0x009AECA8	__DATA	__objc_const</span><br><span class="line">0x1041ECA10	0x00074B98	__DATA	__objc_selrefs</span><br><span class="line">0x1042615A8	0x00000A60	__DATA	__objc_protorefs</span><br><span class="line">0x104262008	0x0000EFE8	__DATA	__objc_classrefs</span><br><span class="line">0x104270FF0	0x0000B490	__DATA	__objc_superrefs</span><br><span class="line">0x10427C480	0x00050BD0	__DATA	__objc_ivar</span><br><span class="line">0x1042CD050	0x000B6010	__DATA	__objc_data</span><br><span class="line">0x104383060	0x000C0CA0	__DATA	__data</span><br><span class="line">0x104443D00	0x00143220	__DATA	__common</span><br><span class="line">0x104586F40	0x0013DAC0	__DATA	__bss</span><br></pre></td></tr></table></figure>
<p>可执行文件大小 = 末位地址(0x104586F40) + size(0x0013DAC0) -  起始地址(0x100002680)。 <strong> 注意是16进制 </strong></p>
<p>详细的 LinkMap 是 这么几部分组成：</p>
<ol>
<li><p>Object files 所编译项目中的所有.obj文件及文件编号</p>
</li>
<li><p>Sections 可执行文件的段表，描述各个段在可执行文件中的偏移位置和大小</p>
</li>
<li><p>Symbols 详细描述各个.obj文件在段表中的分布情况。 可以计算出每个obj文件的占用大小，进而算出每个静态库、功能模块代码占用大小。</p>
</li>
</ol>
<h2 id="官方-Q-amp-A"><a href="#官方-Q-amp-A" class="headerlink" title="官方 Q&amp;A"></a>官方 Q&amp;A</h2><ul>
<li><p><a href="https://developer.apple.com/library/ios/qa/qa1795/_index.html" target="_blank" rel="external">Technical Q&amp;A QA1795 Reducing the size of my App</a></p>
</li>
<li><p><a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/MachORuntime/" target="_blank" rel="external">OS X ABI Mach-O File Format Reference</a></p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
      </nav>
    </section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 miaoyou.gmy&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>